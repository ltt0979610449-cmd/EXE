# H∆∞·ªõng d·∫´n Deploy Spring Boot + MySQL l√™n Fly.io

## Y√™u c·∫ßu tr∆∞·ªõc khi b·∫Øt ƒë·∫ßu

1. **C√†i ƒë·∫∑t Fly.io CLI**:
   - Windows PowerShell: `iwr https://fly.io/install.ps1 -useb | iex`
   - macOS/Linux: `curl -L https://fly.io/install.sh | sh`
   - Ho·∫∑c download t·ª´: https://fly.io/docs/hands-on/install-flyctl/

2. **ƒêƒÉng k√Ω t√†i kho·∫£n Fly.io** (mi·ªÖn ph√≠):
   - Truy c·∫≠p: https://fly.io/app/sign-up
   - Ho·∫∑c ch·∫°y: `fly auth signup`

3. **ƒêƒÉng nh·∫≠p**:
   ```bash
   fly auth login
   ```

4. **‚ö†Ô∏è QUAN TR·ªåNG: Th√™m Payment Information**:
   - Fly.io y√™u c·∫ßu th√™m th√¥ng tin thanh to√°n ƒë·ªÉ x√°c th·ª±c (nh∆∞ng kh√¥ng t√≠nh ph√≠ n·∫øu d√πng trong free tier)
   - Truy c·∫≠p: https://fly.io/dashboard/[your-org]/billing
   - Th√™m credit card (s·∫Ω kh√¥ng b·ªã charge n·∫øu d√πng free tier)
   - Sau khi th√™m payment info, m·ªõi c√≥ th·ªÉ t·∫°o apps

## üöÄ C√°ch nhanh nh·∫•t: S·ª≠ d·ª•ng Script t·ª± ƒë·ªông

**Ch·∫°y script PowerShell ƒë·ªÉ deploy t·ª± ƒë·ªông:**

```powershell
# Deploy c·∫£ MySQL v√† Backend c√πng l√∫c
.\deploy-fly.ps1

# Ho·∫∑c deploy t·ª´ng ph·∫ßn:
.\deploy-mysql-only.ps1    # Ch·ªâ MySQL
.\deploy-backend-only.ps1  # Ch·ªâ Backend (sau khi ƒë√£ c√≥ MySQL)
```

**L∆∞u √Ω**: Script `deploy-fly.ps1` ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh s·∫µn v·ªõi t·∫•t c·∫£ environment variables t·ª´ file `.env` c·ªßa b·∫°n.

---

## C√°ch th·ªß c√¥ng (n·∫øu mu·ªën hi·ªÉu r√µ t·ª´ng b∆∞·ªõc)

## B∆∞·ªõc 0: Chu·∫©n b·ªã Environment Variables

T·∫•t c·∫£ environment variables ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh s·∫µn trong script `deploy-fly.ps1`. N·∫øu deploy th·ªß c√¥ng, b·∫°n s·∫Ω c·∫ßn set ch√∫ng tr√™n Fly.io.

## B∆∞·ªõc 2: Deploy MySQL Database

### 2.1. T·∫°o MySQL App
```bash
fly apps create coiviet-mysql
```

### 2.2. T·∫°o Persistent Volume cho MySQL
```bash
fly volumes create coiviet_mysql_data --size 1 --region sin
```
- `--size 1`: 1GB (ƒë·ªß cho development/small production)
- `--region sin`: Singapore (g·∫ßn Vi·ªát Nam, latency th·∫•p)

### 2.3. Set MySQL Secrets
```bash
fly secrets set \
  MYSQL_ROOT_PASSWORD=your_secure_root_password \
  MYSQL_PASSWORD=your_secure_password \
  -a coiviet-mysql
```

### 2.4. Deploy MySQL
```bash
fly deploy -c fly.mysql.toml
```

### 2.5. Ki·ªÉm tra MySQL ƒë√£ ch·∫°y
```bash
fly status -a coiviet-mysql
fly logs -a coiviet-mysql
```

## B∆∞·ªõc 3: Deploy Spring Boot Backend

### 3.1. T·∫°o Backend App
```bash
fly apps create coiviet-api
```

### 3.2. Set Environment Variables cho Backend

**L∆∞u √Ω quan tr·ªçng**: C·∫≠p nh·∫≠t `DBMS_CONNECTION` ƒë·ªÉ tr·ªè t·ªõi MySQL app tr√™n Fly.io:

```bash
fly secrets set \
  DBMS_CONNECTION="jdbc:mysql://coiviet-mysql.internal:3306/coivietdb?useSSL=false&serverTimezone=Asia/Ho_Chi_Minh&allowPublicKeyRetrieval=true" \
  DBMS_USERNAME="coiviet_user" \
  DBMS_PASSWORD="your_mysql_password" \
  JWT_SIGNER_KEY="your_jwt_signer_key" \
  JWT_VALID_DURATION="your_jwt_valid_duration" \
  JWT_REFRESHABLE_DURATION="your_jwt_refreshable_duration" \
  CLOUDINARY_CLOUD_NAME="your_cloudinary_cloud_name" \
  CLOUDINARY_API_KEY="your_cloudinary_api_key" \
  CLOUDINARY_API_SECRET="your_cloudinary_api_secret" \
  MAIL_USERNAME="your_email@gmail.com" \
  MAIL_PASSWORD="your_email_app_password" \
  MOMO_PARTNER_CODE="your_momo_partner_code" \
  MOMO_ACCESS_KEY="your_momo_access_key" \
  MOMO_SECRET_KEY="your_momo_secret_key" \
  MOMO_REDIRECT_URL="https://coiviet-api.fly.dev/api/payments/momo/callback" \
  MOMO_NOTIFY_URL="https://coiviet-api.fly.dev/api/payments/momo/notify" \
  GOOGLE_CLIENT_ID="your_google_client_id" \
  GOOGLE_CLIENT_SECRET="your_google_client_secret" \
  GOOGLE_REDIRECT_URI="https://coiviet-api.fly.dev/login/oauth2/code/google" \
  OAUTH2_REDIRECT_SUCCESS="https://your-frontend-url.com/oauth2/callback" \
  INITIAL_ADMIN_PASSWORD="your_admin_password" \
  -a coiviet-api
```

**Ho·∫∑c set t·ª´ng bi·∫øn m·ªôt**:
```bash
fly secrets set DBMS_CONNECTION="jdbc:mysql://coiviet-mysql.internal:3306/coivietdb?useSSL=false&serverTimezone=Asia/Ho_Chi_Minh&allowPublicKeyRetrieval=true" -a coiviet-api
fly secrets set DBMS_USERNAME="coiviet_user" -a coiviet-api
# ... ti·∫øp t·ª•c v·ªõi c√°c bi·∫øn kh√°c
```

### 3.3. Deploy Backend
```bash
fly deploy
```

### 3.4. Ki·ªÉm tra Backend ƒë√£ ch·∫°y
```bash
fly status -a coiviet-api
fly logs -a coiviet-api
```

## B∆∞·ªõc 4: Verify Deployment

### 4.1. Ki·ªÉm tra Health Check
```bash
# Backend health
curl https://coiviet-api.fly.dev/actuator/health

# Ho·∫∑c xem trong browser
# https://coiviet-api.fly.dev/actuator/health
```

### 4.2. Ki·ªÉm tra API Swagger
```
https://coiviet-api.fly.dev/swagger-ui.html
```

### 4.3. Ki·ªÉm tra Logs
```bash
# Backend logs
fly logs -a coiviet-api

# MySQL logs
fly logs -a coiviet-mysql

# Follow logs real-time
fly logs -a coiviet-api --follow
```

## B∆∞·ªõc 5: C·∫•u h√¨nh Domain (Optional)

N·∫øu b·∫°n mu·ªën d√πng custom domain:

```bash
fly certs create your-domain.com -a coiviet-api
```

## Local Development v·ªõi Docker Compose

ƒê·ªÉ ch·∫°y local v·ªõi Docker Compose:

```bash
# Start c·∫£ MySQL v√† Backend
docker-compose up -d

# Xem logs
docker-compose logs -f

# Stop
docker-compose down

# Stop v√† x√≥a volumes
docker-compose down -v
```

Backend s·∫Ω ch·∫°y t·∫°i: `http://localhost:8080`
MySQL s·∫Ω ch·∫°y t·∫°i: `localhost:3306`

## Troubleshooting

### MySQL kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ª´ Backend

1. Ki·ªÉm tra MySQL app ƒëang ch·∫°y:
   ```bash
   fly status -a coiviet-mysql
   ```

2. Ki·ªÉm tra connection string trong secrets:
   ```bash
   fly secrets list -a coiviet-api
   ```
   ƒê·∫£m b·∫£o `DBMS_CONNECTION` s·ª≠ d·ª•ng `coiviet-mysql.internal:3306`

3. Ki·ªÉm tra MySQL logs:
   ```bash
   fly logs -a coiviet-mysql
   ```

### Backend kh√¥ng start

1. Ki·ªÉm tra logs:
   ```bash
   fly logs -a coiviet-api
   ```

2. Ki·ªÉm tra memory/CPU:
   ```bash
   fly status -a coiviet-api
   ```
   N·∫øu thi·∫øu memory, c√≥ th·ªÉ c·∫ßn upgrade plan ho·∫∑c optimize JVM settings

3. Ki·ªÉm tra environment variables:
   ```bash
   fly secrets list -a coiviet-api
   ```

### Out of Memory

N·∫øu g·∫∑p l·ªói Out of Memory, c√≥ th·ªÉ:
1. TƒÉng memory trong `fly.toml`: `memory_mb = 1024`
2. Ho·∫∑c optimize JVM settings trong Dockerfile
3. Ho·∫∑c upgrade Fly.io plan

### Database Connection Timeout

1. ƒê·∫£m b·∫£o MySQL app ƒëang ch·∫°y: `fly status -a coiviet-mysql`
2. Ki·ªÉm tra internal DNS: `coiviet-mysql.internal`
3. Ki·ªÉm tra firewall/network rules trong Fly.io

## Fly.io Free Tier Limits

- **3 shared-cpu-1x VMs** (256MB RAM m·ªói VM)
- **3GB persistent volumes** total
- **160GB outbound data transfer** m·ªói th√°ng

**L∆∞u √Ω**: 
- MySQL s·∫Ω d√πng 1 VM (256MB) - c√≥ th·ªÉ ƒë·ªß cho small production
- Backend s·∫Ω d√πng 1 VM (512MB nh∆∞ config trong fly.toml)
- C√≤n l·∫°i 1 VM cho scaling ho·∫∑c testing

## Commands h·ªØu √≠ch

```bash
# List t·∫•t c·∫£ apps
fly apps list

# View app status
fly status -a coiviet-api

# View app info
fly info -a coiviet-api

# SSH v√†o VM
fly ssh console -a coiviet-api

# Scale app
fly scale count 1 -a coiviet-api

# Restart app
fly apps restart coiviet-api

# View secrets
fly secrets list -a coiviet-api

# Remove secret
fly secrets unset KEY_NAME -a coiviet-api

# View logs
fly logs -a coiviet-api

# Destroy app (C·∫®N TH·∫¨N!)
fly apps destroy coiviet-api
```

## Backup Database

```bash
# SSH v√†o MySQL app
fly ssh console -a coiviet-mysql

# Trong MySQL console
mysqldump -u coiviet_user -p coivietdb > backup.sql

# Ho·∫∑c t·ª´ local machine
fly ssh console -a coiviet-mysql -C "mysqldump -u coiviet_user -p coivietdb" > backup.sql
```

## Cost Estimation (Free Tier)

- **MySQL App**: Mi·ªÖn ph√≠ (1 VM shared-cpu-1x)
- **Backend App**: Mi·ªÖn ph√≠ (1 VM shared-cpu-1x)
- **Storage**: Mi·ªÖn ph√≠ (1GB volume trong 3GB limit)
- **Data Transfer**: Mi·ªÖn ph√≠ (160GB/th√°ng)

**T·ªïng**: Ho√†n to√†n mi·ªÖn ph√≠ cho development v√† small production!

## Support

- Fly.io Docs: https://fly.io/docs/
- Fly.io Community: https://community.fly.io/
- Fly.io Status: https://status.fly.io/
