# Hướng dẫn Deploy Spring Boot + MySQL lên Fly.io

## Yêu cầu trước khi bắt đầu

1. **Cài đặt Fly.io CLI**:
   - Windows PowerShell: `iwr https://fly.io/install.ps1 -useb | iex`
   - macOS/Linux: `curl -L https://fly.io/install.sh | sh`
   - Hoặc download từ: https://fly.io/docs/hands-on/install-flyctl/

2. **Đăng ký tài khoản Fly.io** (miễn phí):
   - Truy cập: https://fly.io/app/sign-up
   - Hoặc chạy: `fly auth signup`

3. **Đăng nhập**:
   ```bash
   fly auth login
   ```

## Bước 1: Chuẩn bị Environment Variables

Lấy tất cả các biến môi trường từ file `.env` của bạn. Bạn sẽ cần set chúng trên Fly.io sau.

## Bước 2: Deploy MySQL Database

### 2.1. Tạo MySQL App
```bash
fly apps create coiviet-mysql
```

### 2.2. Tạo Persistent Volume cho MySQL
```bash
fly volumes create coiviet_mysql_data --size 1 --region sin
```
- `--size 1`: 1GB (đủ cho development/small production)
- `--region sin`: Singapore (gần Việt Nam, latency thấp)

### 2.3. Set MySQL Secrets
```bash
fly secrets set \
  MYSQL_ROOT_PASSWORD=your_secure_root_password \
  MYSQL_PASSWORD=your_secure_password \
  -a coiviet-mysql
```

### 2.4. Deploy MySQL
```bash
fly deploy -c fly.mysql.toml
```

### 2.5. Kiểm tra MySQL đã chạy
```bash
fly status -a coiviet-mysql
fly logs -a coiviet-mysql
```

## Bước 3: Deploy Spring Boot Backend

### 3.1. Tạo Backend App
```bash
fly apps create coiviet-api
```

### 3.2. Set Environment Variables cho Backend

**Lưu ý quan trọng**: Cập nhật `DBMS_CONNECTION` để trỏ tới MySQL app trên Fly.io:

```bash
fly secrets set \
  DBMS_CONNECTION="jdbc:mysql://coiviet-mysql.internal:3306/coivietdb?useSSL=false&serverTimezone=Asia/Ho_Chi_Minh&allowPublicKeyRetrieval=true" \
  DBMS_USERNAME="coiviet_user" \
  DBMS_PASSWORD="your_mysql_password" \
  JWT_SIGNER_KEY="your_jwt_signer_key" \
  JWT_VALID_DURATION="your_jwt_valid_duration" \
  JWT_REFRESHABLE_DURATION="your_jwt_refreshable_duration" \
  CLOUDINARY_CLOUD_NAME="your_cloudinary_cloud_name" \
  CLOUDINARY_API_KEY="your_cloudinary_api_key" \
  CLOUDINARY_API_SECRET="your_cloudinary_api_secret" \
  MAIL_USERNAME="your_email@gmail.com" \
  MAIL_PASSWORD="your_email_app_password" \
  MOMO_PARTNER_CODE="your_momo_partner_code" \
  MOMO_ACCESS_KEY="your_momo_access_key" \
  MOMO_SECRET_KEY="your_momo_secret_key" \
  MOMO_REDIRECT_URL="https://coiviet-api.fly.dev/api/payments/momo/callback" \
  MOMO_NOTIFY_URL="https://coiviet-api.fly.dev/api/payments/momo/notify" \
  GOOGLE_CLIENT_ID="your_google_client_id" \
  GOOGLE_CLIENT_SECRET="your_google_client_secret" \
  GOOGLE_REDIRECT_URI="https://coiviet-api.fly.dev/login/oauth2/code/google" \
  OAUTH2_REDIRECT_SUCCESS="https://your-frontend-url.com/oauth2/callback" \
  INITIAL_ADMIN_PASSWORD="your_admin_password" \
  -a coiviet-api
```

**Hoặc set từng biến một**:
```bash
fly secrets set DBMS_CONNECTION="jdbc:mysql://coiviet-mysql.internal:3306/coivietdb?useSSL=false&serverTimezone=Asia/Ho_Chi_Minh&allowPublicKeyRetrieval=true" -a coiviet-api
fly secrets set DBMS_USERNAME="coiviet_user" -a coiviet-api
# ... tiếp tục với các biến khác
```

### 3.3. Deploy Backend
```bash
fly deploy
```

### 3.4. Kiểm tra Backend đã chạy
```bash
fly status -a coiviet-api
fly logs -a coiviet-api
```

## Bước 4: Verify Deployment

### 4.1. Kiểm tra Health Check
```bash
# Backend health
curl https://coiviet-api.fly.dev/actuator/health

# Hoặc xem trong browser
# https://coiviet-api.fly.dev/actuator/health
```

### 4.2. Kiểm tra API Swagger
```
https://coiviet-api.fly.dev/swagger-ui.html
```

### 4.3. Kiểm tra Logs
```bash
# Backend logs
fly logs -a coiviet-api

# MySQL logs
fly logs -a coiviet-mysql

# Follow logs real-time
fly logs -a coiviet-api --follow
```

## Bước 5: Cấu hình Domain (Optional)

Nếu bạn muốn dùng custom domain:

```bash
fly certs create your-domain.com -a coiviet-api
```

## Local Development với Docker Compose

Để chạy local với Docker Compose:

```bash
# Start cả MySQL và Backend
docker-compose up -d

# Xem logs
docker-compose logs -f

# Stop
docker-compose down

# Stop và xóa volumes
docker-compose down -v
```

Backend sẽ chạy tại: `http://localhost:8080`
MySQL sẽ chạy tại: `localhost:3306`

## Troubleshooting

### MySQL không kết nối được từ Backend

1. Kiểm tra MySQL app đang chạy:
   ```bash
   fly status -a coiviet-mysql
   ```

2. Kiểm tra connection string trong secrets:
   ```bash
   fly secrets list -a coiviet-api
   ```
   Đảm bảo `DBMS_CONNECTION` sử dụng `coiviet-mysql.internal:3306`

3. Kiểm tra MySQL logs:
   ```bash
   fly logs -a coiviet-mysql
   ```

### Backend không start

1. Kiểm tra logs:
   ```bash
   fly logs -a coiviet-api
   ```

2. Kiểm tra memory/CPU:
   ```bash
   fly status -a coiviet-api
   ```
   Nếu thiếu memory, có thể cần upgrade plan hoặc optimize JVM settings

3. Kiểm tra environment variables:
   ```bash
   fly secrets list -a coiviet-api
   ```

### Out of Memory

Nếu gặp lỗi Out of Memory, có thể:
1. Tăng memory trong `fly.toml`: `memory_mb = 1024`
2. Hoặc optimize JVM settings trong Dockerfile
3. Hoặc upgrade Fly.io plan

### Database Connection Timeout

1. Đảm bảo MySQL app đang chạy: `fly status -a coiviet-mysql`
2. Kiểm tra internal DNS: `coiviet-mysql.internal`
3. Kiểm tra firewall/network rules trong Fly.io

## Fly.io Free Tier Limits

- **3 shared-cpu-1x VMs** (256MB RAM mỗi VM)
- **3GB persistent volumes** total
- **160GB outbound data transfer** mỗi tháng

**Lưu ý**: 
- MySQL sẽ dùng 1 VM (256MB) - có thể đủ cho small production
- Backend sẽ dùng 1 VM (512MB như config trong fly.toml)
- Còn lại 1 VM cho scaling hoặc testing

## Commands hữu ích

```bash
# List tất cả apps
fly apps list

# View app status
fly status -a coiviet-api

# View app info
fly info -a coiviet-api

# SSH vào VM
fly ssh console -a coiviet-api

# Scale app
fly scale count 1 -a coiviet-api

# Restart app
fly apps restart coiviet-api

# View secrets
fly secrets list -a coiviet-api

# Remove secret
fly secrets unset KEY_NAME -a coiviet-api

# View logs
fly logs -a coiviet-api

# Destroy app (CẨN THẬN!)
fly apps destroy coiviet-api
```

## Backup Database

```bash
# SSH vào MySQL app
fly ssh console -a coiviet-mysql

# Trong MySQL console
mysqldump -u coiviet_user -p coivietdb > backup.sql

# Hoặc từ local machine
fly ssh console -a coiviet-mysql -C "mysqldump -u coiviet_user -p coivietdb" > backup.sql
```

## Cost Estimation (Free Tier)

- **MySQL App**: Miễn phí (1 VM shared-cpu-1x)
- **Backend App**: Miễn phí (1 VM shared-cpu-1x)
- **Storage**: Miễn phí (1GB volume trong 3GB limit)
- **Data Transfer**: Miễn phí (160GB/tháng)

**Tổng**: Hoàn toàn miễn phí cho development và small production!

## Support

- Fly.io Docs: https://fly.io/docs/
- Fly.io Community: https://community.fly.io/
- Fly.io Status: https://status.fly.io/
